<?php

/**
 * Implementation of hook_menu().
 */
function tzintellitime_menu() {
  $items = array();
  $items['admin/settings/timezynk/tzintellitime'] = array(
    'title' => 'Intellitime',
    'description' => 'Sitewide settings for the TimeZynk Intellitime bridge.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tzintellitime_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'tzintellitime.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_form_alter().
 */
function tzintellitime_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['#validate']) && is_array($form['#validate']) && ($key = array_search('user_login_authenticate_validate', $form['#validate']))) {
    $form['#validate'][$key] = 'tzintellitime_login_authenticate_validate';
  }
}

function tzintellitime_login_authenticate_validate($form, &$form_state) {
  global $user;
  $username = $form_state['values']['name'];
  $password = $form_state['values']['pass'];

  // Check for valid user name
  user_login_name_validate($form, $form_state);

  // Intellitime bot will fail to login if the URL is empty, no need to check $url.
  $url = variable_get('tzintellitime_base_url', '');

  // Load the user if it is exists and is not blocked
  $account = user_load(array('name' => $username, 'status' => 1));

  // Any errors so far?
  if(form_get_errors()) {
    return;
  }
  if (!$account || isset($account->intellitime_user) && !_tzintellitime_is_authenticated($account)) {
    // new user or existing user with expired cookie-jar.
    require_once dirname(__FILE__) . '/tzintellitime.class.inc';
    $cookiejar = tempnam(file_directory_temp(), 'tzintellitime');
    $bot = new TZIntellitimeBot($url, $cookiejar);
    if(!$bot->login($username, $password)) {
      unlink($cookiejar);
      return;
    }
    if ($account) {
      $mail = $account->mail;
      $init = $account->init;
    } else {
      $mail = $username;
      $init = $username;
    }
    $user = user_save($account, array(
      'name' => $username,
      'pass' => $password,
      'status' => 1,
      'mail' => $mail,
      'init' => $init,
      'intellitime_user' => TRUE,
      'intellitime_cookiejar' => $cookiejar,
     ));
  } else {
    // Admins and existing users with cookiejars in order authenticate normally.
    user_authenticate($form_state['values']);
  }
}

/**
 *
 * Private function to check if an account that has already
 * been verified to be an intellitime account has valid authentication.
 * @param unknown_type $account
 */
function _tzintellitime_is_authenticated($account) {
  return ($account && $account->intellitime_user &&
          isset($account->intellitime_cookiejar) &&
          file_exists($account->intellitime_cookiejar));
}